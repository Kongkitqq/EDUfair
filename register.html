<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สมัครสมาชิก - งานนิทรรศการการศึกษา</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-lg">
        <a href="/index.html" class="inline-block bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 mb-6">ย้อนกลับ</a>
        <h2 class="text-2xl font-bold mb-6 text-center">สมัครสมาชิก</h2>
        <form id="registerForm" enctype="multipart/form-data" class="space-y-4">
            <!-- Profile Image Preview -->
            <div class="flex justify-center mb-4">
                <img id="profileImagePreview" src="/images/default-profile.png" alt="Profile Preview" class="w-24 h-24 rounded-full object-cover border-2 border-gray-200">
            </div>
            <!-- Profile Image Input -->
            <div>
                <label for="profile_image" class="block text-sm font-medium text-gray-700">รูปโปรไฟล์ (ไม่บังคับ)</label>
                <input type="file" id="profile_image" name="profile_image" accept="image/*" class="w-full p-2 border rounded-md text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:bg-blue-500 file:text-white hover:file:bg-blue-600">
            </div>
            <!-- Full Name -->
            <div>
                <label for="full_name" class="block text-sm font-medium text-gray-700">ชื่อ-สกุล</label>
                <input type="text" id="full_name" name="full_name" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <!-- Username -->
            <div>
                <label for="username" class="block text-sm font-medium text-gray-700">ชื่อผู้ใช้</label>
                <input type="text" id="username" name="username" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <!-- Password -->
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">รหัสผ่าน</label>
                <input type="password" id="password" name="password" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" minlength="6" required>
            </div>
            <!-- Confirm Password -->
            <div>
                <label for="confirmPassword" class="block text-sm font-medium text-gray-700">ยืนยันรหัสผ่าน</label>
                <input type="password" id="confirmPassword" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" minlength="6" required>
            </div>
            <!-- Email -->
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">อีเมล</label>
                <input type="email" id="email" name="email" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
            </div>
            <!-- Phone -->
            <div>
                <label for="phone" class="block text-sm font-medium text-gray-700">โทรศัพท์</label>
                <input type="text" id="phone" name="phone" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <!-- Organization Phone -->
            <div>
                <label for="organization_phone" class="block text-sm font-medium text-gray-700">โทรศัพท์องค์กร</label>
                <input type="text" id="organization_phone" name="organization_phone" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <!-- Institute Name -->
            <div>
                <label for="institute_name" class="block text-sm font-medium text-gray-700">สถาบัน</label>
                <select id="institute_name" name="institute_name" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" required>
                    <option value="">เลือกสถาบัน</option>
                </select>
            </div>
            <!-- Position -->
            <div>
                <label for="position" class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                <input type="text" id="position" name="position" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <!-- Affiliation -->
            <div>
                <label for="affiliation" class="block text-sm font-medium text-gray-700">หน่วยงาน/คณะ</label>
                <input type="text" id="affiliation" name="affiliation" class="w-full p-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
            </div>
            <!-- Buttons -->
            <div class="flex space-x-4">
                <button type="button" id="cancelButton" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">ยกเลิก</button>
                <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">สมัครสมาชิก</button>
            </div>
        </form>
        <p class="mt-4 text-center">
            มีบัญชีอยู่แล้ว? <a href="/index.html" class="text-blue-600 hover:underline">เข้าสู่ระบบ</a>
        </p>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-md w-full max-w-sm">
            <h3 class="text-xl font-semibold mb-4" id="notificationTitle"></h3>
            <p id="notificationMessage"></p>
            <button id="closeNotification" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 mt-4">ตกลง</button>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-md flex items-center">
            <svg class="animate-spin h-5 w-5 mr-3" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span>กำลังโหลด...</span>
        </div>
    </div>

    <script>
        function showNotification(title, message) {
            document.getElementById("notificationTitle").textContent = title;
            document.getElementById("notificationMessage").textContent = message;
            document.getElementById("notificationModal").classList.remove("hidden");
            document.getElementById("closeNotification").addEventListener("click", () => {
                document.getElementById("notificationModal").classList.add("hidden");
            }, { once: true });
        }

        function showLoading(show) {
            document.getElementById("loadingModal").classList.toggle("hidden", !show);
        }

        // Load institutes
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Fetching institutes');
            try {
                const response = await fetch('http://localhost:3000/institutes');
                if (!response.ok) throw new Error('Failed to fetch institutes');
                const institutes = await response.json();
                console.log('Institutes fetched:', institutes);
                const select = document.getElementById('institute_name');
                institutes.forEach(inst => {
                    const option = document.createElement('option');
                    option.value = inst.institute_name;
                    option.textContent = inst.institute_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching institutes:', error);
                showNotification('เกิดข้อผิดพลาด', 'ไม่สามารถโหลดรายชื่อสถาบันได้');
            }
        });

        // Preview profile image
        document.getElementById('profile_image').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                if (!file.type.startsWith('image/')) {
                    showNotification('ข้อผิดพลาด', 'กรุณาเลือกไฟล์รูปภาพ');
                    event.target.value = '';
                    return;
                }
                if (file.size > 5 * 1024 * 1024) {
                    showNotification('ข้อผิดพลาด', 'ไฟล์ใหญ่เกิน 5MB');
                    event.target.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('profileImagePreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('profileImagePreview').src = '/images/default-profile.png';
            }
        });

        // Handle register form submission
        document.getElementById('registerForm').addEventListener('submit', async (event) => {
            event.preventDefault();
            const full_name = document.getElementById('full_name').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            const organization_phone = document.getElementById('organization_phone').value;
            const institute_name = document.getElementById('institute_name').value;
            const position = document.getElementById('position').value;
            const affiliation = document.getElementById('affiliation').value;
            const profileImage = document.getElementById('profile_image').files[0];

            // Validate inputs
            if (password !== confirmPassword) {
                showNotification('ข้อผิดพลาด', 'รหัสผ่านและยืนยันรหัสผ่านไม่ตรงกัน');
                return;
            }
            if (password.length < 6) {
                showNotification('ข้อผิดพลาด', 'รหัสผ่านต้องมีอย่างน้อย 6 ตัวอักษร');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showNotification('ข้อผิดพลาด', 'รูปแบบอีเมลไม่ถูกต้อง');
                return;
            }
            if (phone && !/^\d{10}$/.test(phone)) {
                showNotification('ข้อผิดพลาด', 'หมายเลขโทรศัพท์ต้องเป็นตัวเลข 10 หลัก');
                return;
            }
            if (organization_phone && !/^\d{10}$/.test(organization_phone)) {
                showNotification('ข้อผิดพลาด', 'หมายเลขโทรศัพท์องค์กรต้องเป็นตัวเลข 10 หลัก');
                return;
            }

            const formData = new FormData();
            formData.append('full_name', full_name);
            formData.append('username', username);
            formData.append('password', password);
            formData.append('email', email);
            formData.append('phone', phone);
            formData.append('organization_phone', organization_phone);
            formData.append('institute_name', institute_name);
            formData.append('position', position);
            formData.append('affiliation', affiliation);
            if (profileImage) {
                formData.append('profile_image', profileImage);
            }

            console.log('Submitting registration form:', {
                full_name,
                username,
                password: '[HIDDEN]',
                email,
                phone,
                organization_phone,
                institute_name,
                position,
                affiliation,
                profile_image: profileImage ? profileImage.name : null
            });

            try {
                showLoading(true);
                const response = await fetch('http://localhost:3000/register', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                if (!response.ok) {
                    console.log('Registration response error:', data);
                    throw new Error(data.error || 'Registration failed');
                }
                console.log('Registration successful:', data);
                showNotification('สำเร็จ', 'สมัครสมาชิกสำเร็จ กรุณาเข้าสู่ระบบ');
                setTimeout(() => window.location.href = '/index.html', 2000);
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('เกิดข้อผิดพลาด', `ไม่สามารถสมัครสมาชิกได้: ${error.message}`);
            } finally {
                showLoading(false);
            }
        });

        // Handle cancel button
        document.getElementById('cancelButton').addEventListener('click', () => {
            document.getElementById('registerForm').reset();
            document.getElementById('profileImagePreview').src = '/images/default-profile.png';
        });
    </script>
</body>
</html>